- name: Update All Containers
        run: |
          echo "ðŸš€ Scanning for docker-compose files..."
          
          find . -name "docker-compose.y*ml" -print0 | while IFS= read -r -d '' file; do
            dir=$(dirname "$file")
            # Get just the folder name (e.g., "audiobookshelf") to match against NAS
            stack_name=$(basename "$dir")
            
            echo "---------------------------------------------------"
            echo "ðŸ“‚ Processing Stack: $stack_name"
            echo "---------------------------------------------------"
            
            cd "$dir"
            
            # 1. SECRET INJECTION: Copy .env from NAS storage if it exists
            # We look in /mnt/nas-docker (which we mounted in Step 1)
            if [ -f "/mnt/nas-docker/$stack_name/.env" ]; then
                echo "   ðŸ”‘ Found secrets on NAS! Injecting .env file..."
                cp "/mnt/nas-docker/$stack_name/.env" ./.env
                CMD="docker compose --env-file .env"
            else
                echo "   âš ï¸ No .env file found on NAS for this stack."
                CMD="docker compose"
            fi
            
            # 2. Pull new images
            docker compose pull

            # 3. Conflict Handling & Deployment
            if ! $CMD up -d --remove-orphans; then
              echo "   âš ï¸ Conflict detected! Force recreating..."
              $CMD down --remove-orphans
              $CMD up -d
            fi
            
            cd - > /dev/null
          done
