name: NAS Container Update

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '**/docker-compose.y*ml'

jobs:
  deploy:
    runs-on: [self-hosted, nas]
    timeout-minutes: 60  # Increased to handle larger pulls
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Determine Stacks to Update
        id: filter
        run: |
          STACKS=""
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            STACKS=$(find . -name "docker-compose.y*ml")
          else
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
            STACKS=$(echo "$CHANGED_FILES" | grep "docker-compose" | xargs -L1 dirname | sort -u | xargs -I {} find {} -name "docker-compose.y*ml")
          fi
          { echo "STACK_LIST<<EOF"; echo "$STACKS"; echo "EOF"; } >> $GITHUB_ENV

      - name: Deploy Stacks
        if: env.STACK_LIST != ''
        run: |
          echo "$STACK_LIST" | while IFS= read -r file; do
            [ -z "$file" ] && continue
            dir=$(dirname "$file")
            stack_name=$(basename "$dir")
            cd "$dir"
            
            # Injecting .env from NAS [cite: 2025-12-21, 2025-12-27]
            [ -f "/volume2/FastSSD/docker/$stack_name/.env" ] && cp "/volume2/FastSSD/docker/$stack_name/.env" ./.env || touch ./.env
            
            docker compose down --remove-orphans
            docker compose pull --quiet # Suppressing logs to prevent thrashing
            docker compose up -d --remove-orphans
            cd - > /dev/null
          done

      - name: Cleanup
        run: docker image prune -f

      - name: Notify Success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"✅ **NAS Update Successful**\n**Environment:** UGreen 2800DXP\n**Status:** Deployment complete.\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Notify Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"❌ **NAS Update FAILED**\n**Check Logs:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
