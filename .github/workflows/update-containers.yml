name: NAS Container Update

on:
  # Allows manual run from the Actions tab
  workflow_dispatch:
  # Runs automatically when you push changes to compose files
  push:
    branches:
      - main
    paths:
      - '**/docker-compose.yml'
      - '**/docker-compose.yaml'

jobs:
  deploy:
    runs-on: [self-hosted, nas]
    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Update All Containers
        run: |
          echo "ðŸš€ Scanning for docker-compose files..."
          
          # Loop through every docker-compose file found in the repo
          find . -name "docker-compose.y*ml" -print0 | while IFS= read -r -d '' file; do
            dir=$(dirname "$file")
            # Extract just the folder name (e.g. "audiobookshelf")
            stack_name=$(basename "$dir")
            
            echo "---------------------------------------------------"
            echo "ðŸ“‚ Processing Stack: $stack_name"
            echo "---------------------------------------------------"
            
            cd "$dir"
            
            # 1. SECRET INJECTION
            # We look for the .env file in the mounted NAS path
            if [ -f "/mnt/nas-docker/$stack_name/.env" ]; then
                echo "   ðŸ”‘ Found secrets on NAS! Injecting .env file..."
                cp "/mnt/nas-docker/$stack_name/.env" ./.env
                CMD="docker compose --env-file .env"
            else
                echo "   âš ï¸ No .env file found on NAS for this stack."
                CMD="docker compose"
            fi
            
            # 2. Pull new images
            docker compose pull

            # 3. Conflict Handling & Deployment
            # If 'up' fails, we assume it's a conflict, remove the old container, and retry.
            if ! $CMD up -d --remove-orphans; then
              echo "   âš ï¸ Conflict detected! Force recreating..."
              $CMD down --remove-orphans
              $CMD up -d
            fi
            
            # Go back to root for the next loop
            cd - > /dev/null
          done

      - name: Cleanup
        run: docker image prune -f
