name: NAS Container Update

on:
  # 1. Manual Trigger
  workflow_dispatch:
  
  # 2. Automatic Trigger
  push:
    branches:
      - main
    paths:
      - '**/docker-compose.yml'
      - '**/docker-compose.yaml'

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted, nas]
    steps:
      - name: Checkout Code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Update All Containers
        run: |
          echo "ðŸš€ Scanning for docker-compose files..."
          
          # Loop through every docker-compose file found in the repo
          find . -name "docker-compose.y*ml" -print0 | while IFS= read -r -d '' file; do
            dir=$(dirname "$file")
            # Extract just the folder name (e.g. "radarr")
            stack_name=$(basename "$dir")
            
            echo "---------------------------------------------------"
            echo "ðŸ“‚ Processing Stack: $stack_name"
            echo "---------------------------------------------------"
            
            cd "$dir"
            
            # 1. SECRET INJECTION
            # Look for the .env file in the mapped volume path on the NAS
            TARGET_ENV="/volume2/FastSSD/docker/$stack_name/.env"
            
            echo "   ðŸ” Debug: Checking for secrets at $TARGET_ENV"

            if [ -f "$TARGET_ENV" ]; then
                echo "   ðŸ”‘ Found secrets on NAS! Injecting .env file..."
                cp "$TARGET_ENV" ./.env
            else
                echo "   âš ï¸ No .env file found at $TARGET_ENV."
                echo "   ðŸ›¡ï¸ Creating an empty .env file to satisfy compose requirements."
                touch ./.env
            fi
            
            # 2. STOP EXISTING CONTAINERS (The Sledgehammer Fix)
            # Bring down the old stack FIRST to prevent Docker from renaming it to avoid collisions.
            echo "   ðŸ›‘ Stopping old containers to prevent naming conflicts..."
            docker compose down --remove-orphans
            
            # 3. PULL NEW IMAGES
            echo "   â¬‡ï¸ Pulling latest images..."
            docker compose pull

            # 4. START NEW CONTAINERS
            echo "   ðŸš€ Starting new containers..."
            if ! docker compose up -d --remove-orphans; then
              echo "   âŒ ERROR: Failed to start containers for $stack_name"
            else
              echo "   âœ… Successfully deployed $stack_name"
            fi
            
            # Go back to root for the next loop
            cd - > /dev/null
          done

      - name: Cleanup
        run: docker image prune -f
