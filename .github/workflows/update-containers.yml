name: NAS Container Update

on:
  # 1. Manual Trigger
  workflow_dispatch:
  
  # 2. Automatic Trigger
  push:
    branches:
      - main
    paths:
      - '**/docker-compose.yml'
      - '**/docker-compose.yaml'

jobs:
  deploy:
    runs-on: [self-hosted, nas]
    steps:
      - name: Checkout Code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 2  # Required to detect changed files

      - name: Determine Stacks to Update
        id: filter
        run: |
          STACKS=""
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "üëâ Manual Trigger detected: Updating ALL stacks."
            STACKS=$(find . -name "docker-compose.y*ml")
          else
            echo "üëâ Push detected: analyzing changes..."
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
            STACKS=$(echo "$CHANGED_FILES" | grep "docker-compose" | xargs -L1 dirname | sort -u | xargs -I {} find {} -name "docker-compose.y*ml")
            
            if [ -z "$STACKS" ]; then
               echo "‚ö†Ô∏è No docker-compose files were modified. Nothing to update."
            else
               echo "üëâ Detected changes in the following stacks:"
               echo "$STACKS"
            fi
          fi
          
          {
            echo "STACK_LIST<<EOF"
            echo "$STACKS"
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Deploy Stacks
        if: env.STACK_LIST != ''
        run: |
          echo "üöÄ Starting Deployment..."
          
          echo "$STACK_LIST" | while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            dir=$(dirname "$file")
            stack_name=$(basename "$dir")
            
            echo "---------------------------------------------------"
            echo "üìÇ Processing Stack: $stack_name"
            echo "---------------------------------------------------"
            
            cd "$dir"
            
            TARGET_ENV="/volume2/FastSSD/docker/$stack_name/.env"
            
            if [ -f "$TARGET_ENV" ]; then
                echo "   üîë Found secrets on NAS! Injecting .env file..."
                cp "$TARGET_ENV" ./.env
            else
                echo "   üõ°Ô∏è Creating an empty .env file to satisfy compose requirements."
                touch ./.env
            fi
            
            echo "   üõë Stopping old containers..."
            docker compose down --remove-orphans
            
            echo "   ‚¨áÔ∏è Pulling latest images..."
            docker compose pull --quiet

            echo "   üöÄ Starting new containers..."
            if ! docker compose up -d --remove-orphans; then
              echo "   ‚ùå ERROR: Failed to start $stack_name"
            else
              echo "   ‚úÖ Successfully deployed $stack_name"
            fi
            
            cd - > /dev/null
          done

      - name: Cleanup
        run: docker image prune -f

      - name: Notify Success
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"‚úÖ **NAS Update Successful**\n**Environment:** UGreen 2800DXP\n**Status:** All containers synchronised with main branch.\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
