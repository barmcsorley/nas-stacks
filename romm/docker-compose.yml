version: '3.8'

services:
  db:
    image: postgres:17
    container_name: RomM-DB
    security_opt:
      - no-new-privileges:true
    healthcheck:
      # Hardcoded values here to ensure healthcheck passes
      test: ["CMD", "pg_isready", "-q", "-d", "romm", "-U", "rommuser"]
      timeout: 45s
      interval: 10s
      retries: 10
    volumes:
      - /volume2/FastSSD/docker/romm/db:/var/lib/postgresql/data:rw
    environment:
      # HARDCODED: These ensure the DB is created with these exact credentials
      - POSTGRES_DB=romm
      - POSTGRES_USER=rommuser
      - POSTGRES_PASSWORD=rommpass
    restart: on-failure:5

  romm:
    image: rommapp/romm:latest
    container_name: RomM
    healthcheck:
      test: timeout 10s bash -c ':> /dev/tcp/127.0.0.1/8080' || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    environment:
      - ROMM_DB_DRIVER=postgresql
      - DB_HOST=db                # FIXED: Points directly to the service name 'db' on line 4
      - DB_NAME=romm              # Hardcoded
      - DB_USER=rommuser          # Hardcoded
      - DB_PASS=rommpass          # Hardcoded & Fixed typo (was DB_PASSWD)
      - DB_PORT=5432
      # Secrets & Keys (Hardcoded from your screenshot)
      - ROMM_AUTH_SECRET_KEY=9c9e5aabb2bd7171615b94c8cd29dd6196ea6492364f5705715d16b54cc9ec45
      - IGDB_CLIENT_ID=rxo6lxu142n09c8q9vt9k9m02nv2w1
      - IGDB_CLIENT_SECRET=xeen56g4qv67nusyfbg6xpj0mm86l6
      # Standard NAS Permissions
      - PUID=1000
      - PGID=10
    volumes:
      - /volume2/FastSSD/docker/romm/resources:/romm/resources:rw
      - /volume2/FastSSD/docker/romm/redis:/redis-data:rw
      - /volume1/SlowHDD/games:/romm/library:rw
      - /volume2/FastSSD/docker/romm/games/assets:/romm/assets:rw
      - /volume2/FastSSD/docker/romm/games/config:/romm/config:rw
    ports:
      - 7676:8080
    depends_on:
      db:
        condition: service_healthy
    restart: on-failure:10
