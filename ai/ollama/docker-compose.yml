services:
  ollama:
    image: ollama/ollama:latest@sha256:b165fa2700dc374f8d4f9e8314d81c7be75487c76eee2b46ef4b511a496b736c
    container_name: ollama
    restart: unless-stopped
    env_file:
      - /volume2/FastSSD/docker/ollama/.env
    volumes:
      - /volume2/FastSSD/docker/ollama/models:/root/.ollama
    networks:
      - deepseek-net
    healthcheck:
      # Using /bin/sh to check the port directly instead of relying on curl
      test: ["CMD-SHELL", "ls /proc/net/tcp | grep -q 2EB2 || exit 1"] 
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s # Increased from 30s to 90s for slower NAS boot-ups
  open-webui:
    image: ghcr.io/open-webui/open-webui:main@sha256:ea750f19fc2a7ca0cb221bc512b8c2c470a01616b89ed98cb77d9ab0d5f24109
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "3000:8080"
    env_file:
      - /volume2/FastSSD/docker/ollama/.env
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
    volumes:
      - /volume2/FastSSD/docker/open-webui/data:/app/backend/data
    depends_on:
      ollama:
        condition: service_healthy # Only starts UI once Ollama is confirmed healthy
    networks:
      - deepseek-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  deepseek-net:
    driver: bridge
