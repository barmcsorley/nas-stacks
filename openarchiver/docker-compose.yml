services:
  open-archiver:
    image: logiclabshq/open-archiver:latest
    container_name: OpenArchiver-WEB
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 3000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    environment:
      - NODE_ENV=production
      - STORAGE_TYPE=local
      # Redis Connection
      - REDIS_HOST=valkey
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASS}
      # Database Connection
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASS}
      # Constructed URL using the variables above:
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASS}@openarchiver-db:5432/${DB_NAME}
      # Secrets
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=7d
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      # Internal Services
      - MEILI_HOST=http://meilisearch:7700
      - TIKA_URL=http://tika:9998
      - STORAGE_LOCAL_ROOT_PATH=/var/data/open-archiver
      - PORT_BACKEND=4000
      - PORT_FRONTEND=3000
      - SYNC_FREQUENCY=0 0 */2 * * *
    ports:
       - 3212:3000
    volumes:
       - openarchiver_storage:/var/data/open-archiver:rw
    depends_on:
       - db
       - valkey
       - meilisearch
    restart: on-failure:5

  db:
    image: postgres:17-alpine
    container_name: OpenArchiver-DB
    hostname: openarchiver-db
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "pg_isready", "-q", "-d", "${DB_NAME}", "-U", "${DB_USER}"]
      timeout: 45s
      interval: 10s
      retries: 10
    environment:
       - POSTGRES_DB=${DB_NAME}
       - POSTGRES_USER=${DB_USER}
       - POSTGRES_PASSWORD=${DB_PASS}
    volumes:
       - openarchiver_postgres:/var/lib/postgresql/data
    restart: on-failure:5

  valkey:
    image: valkey/valkey:8-alpine
    container_name: OpenArchiver-REDIS
    healthcheck:
     test: ["CMD-SHELL", "redis-cli ping || exit 1"]
    # We inject the password variable into the command line here:
    command: valkey-server --requirepass ${REDIS_PASS}
    volumes:
      - openarchiver_valkey:/data
    restart: on-failure:5

  meilisearch:
    image: getmeili/meilisearch:v1.15
    container_name: OpenArchiver-MEILI
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
    volumes:
      - openarchiver_meili:/meili_data
    restart: on-failure:5

  tika:
      image: apache/tika:3.2.2.0-full
      container_name: Open-Archiver-TIKA
      restart: on-failure:5

volumes:
  openarchiver_storage:
  openarchiver_postgres:
  openarchiver_valkey:
  openarchiver_meili:
